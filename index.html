<!-- Assignment Three (02.526 Interactive Data Visualisation) -->

<!DOCTYPE html>
<html>

<head>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <center><h1 style="color:#515A5A;"> ðŸ§  is Singapore dense? ðŸ§  </h1></center>
  <center><p style="color:#515A5A">Data retrieved from <a href="https://data.gov.sg">data.gov.sg</a></p></center>
  <center><p style="color:#515A5A">Work in Progress: only the male population reflected </p></center>
  <title> Assignment Three </title></center>
  <meta name="author" content="Rachel Ng (1002409)">
  <link href = "index.css" rel = "stylesheet" type="text/css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <div class="tooltip"></div>
</head>

<body>
  <div id="map"></div>
  <svg id="districts"></svg>
  <div class="tooltip"></div>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>

  var colorScale = d3.scaleThreshold()
    // .domain([10, 100, 500, 1000, 2500, 5000, 10000, 25000, 50000])
    .domain(d3.range(2, 10000))
    // .range(['#800026', '#BD0026', '#E31A1C' , '#FC4E2A', '#FD8D3C' , '#FEB24C' , '#FED976' , '#FFEDA0']);
    .range(d3.schemeBlues[9]);

  let tiles = new L.tileLayer('https://maps-{s}.onemap.sg/v3/Default/{z}/{x}/{y}.png', {
    detectRetina: true,
    maxZoom: 20,
    minZoom: 11.5,
    //Do not remove this attribution
    attribution: '<img src="https://docs.onemap.sg/maps/images/oneMap64-01.png" style="height:20px;width:20px;">' +
                 'New OneMap | Map data Â© contributors, <a href="http://SLA.gov.sg">Singapore Land Authority</a>'
  });

  let map = new L.Map("map", {
    // center: [1.347833, 103.809357], 
    center: [1.2789, 103.8536], 
    zoom: 11.5,
    maxBounds: L.latLngBounds(L.latLng(1.1, 103.5), L.latLng(1.5, 104.3))
    })
    .addLayer(tiles);

  let svg = d3.select(map.getPanes().overlayPane)
    .append("svg")
    // .attr("width", 1000)
    // .attr("height", 600)
    .attr("width", window.innerWidth)
    .attr("height", window.innerHeight)
        .append("g")
        .attr("id","svgLayer")
        .attr("class", "leaflet-zoom-hide");

  function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

  let projection = d3.geoTransform({point: projectPoint});
  let geopath = d3.geoPath().projection(projection);

  // Load external data and boot (put full GitHub url)
  Promise.all([d3.json("sgmap.json"), d3.csv("population2020.csv")]).then(data => {

    // console.log(data[0]);
    // console.log(data[1]);

    let sgmap = data[0]
    let population2020 = data[1]
    let geopath = d3.geoPath().projection(projection);

    // adding population to subzone
    for(i=0; i<population2020.length; i++){
      // grab subzone name
      var dataSubz = population2020[i].Subzone;
      //grab data value, and convert from string to float
      var dataValue = parseFloat(population2020[i].Population);
      //find the corresponding state inside the GeoJSON
      for(var n = 0; n < sgmap.features.length; n++){
        // properties name gets the states name
        var jsonSubz = sgmap.features[n].properties.Name;
        // if statment to merge by name of state
        if(dataSubz.toUpperCase() == jsonSubz){
          //Copy the data value into the JSON
          // basically creating a new value column in JSON data
          sgmap.features[n].properties.value = dataValue;
          console.log(dataValue, dataSubz)
          //stop looking through the JSON
          break;
        }
      }
    }
  
map.on('zoomend', onZoom);
  // zoom in and out
  function onZoom() {
    var bounds = geopath.bounds(data[0]),
        topLeft = bounds[0],
        bottomRight = bounds[1];

    var svg = d3.select(map.getPanes().overlayPane).select("svg");
        
    svg
      .attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0] + "px")
      .style("top", topLeft[1] + "px");
       
    svg.select("g").attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
    d3.select("g#districts").selectAll("path")
       .attr("d", geopath);
  }

  svg.append("g")
    .attr("id", "districts")
    .selectAll("path")
    .data(sgmap.features)
    .enter()
    .append("path")
    .attr("d", geopath)
    // .classed("district", true) //black base map if commented out
    .classed("leaflet-interactive", true)
    // .on("mouseover", handleMouseOver)
    // .on("mouseout", handleMouseOut);

    .on("mouseover", (event, dataValue) => {
      if (dataValue.properties.value > 0){
        d3.select(".tooltip")
        .text(dataValue.properties.Name + ": "+ dataValue.properties.value)
        .style("fill", function(dataValue) {return colorScale(d.properties.value)})
        // .style("left", (event.pageX+15) + "px")
        // .style("top", (event.pageY+15) + "px");
      }
      else {
        d3.select(".tooltip")
        .text(dataSubz + ": "+ "undefined")
        // .text(dataValue + ": "+ "undefined")
        .style("left", (event.pageX+15) + "px")
        .style("top", (event.pageY+15) + "px") }
      })
    .attr("fill", dataValue => {
      return colorScale(dataValue)
    })
    .on("mouseout", (event,dataValue)=> {
      d3.select(".tooltip")
      .text("");
      d3.select(svg.selectAll("path")
      .attr("opacity", 1));
      d3.select(event.currentTarget) 
    });

  // // Create Event Handlers for mouse
  // function handleMouseOver(d, i) {  // Add interactivity
  //   // Use D3 to select element, change color and size
  //   if (dataValue >0){
  //     d3.select(".tooltip")
  //     .text(jsonSubz + ": "+ dataValue)
  //     .style("left", (event.pageX+13) + "px")
  //     .style("top", (event.pageY+13) + "px");
  //   }
  //   else {
  //     d3.select(".tooltip")
  //     .text(jsonSubz + ": "+ "undefined")
  //     .style("left", (event.pageX+13) + "px")
  //     .style("top", (event.pageY+13) + "px") 
  //   };
  //   // d3.select(this).attr({
  //   //   fill: "orange",
  //   //   r: radius * 2
  //   // });

  //   // Specify where to put label of text
  //   svg.append("text").attr({
  //      id: "t" + d.x + "-" + d.y + "-" + i,  // Create an id for text so we can select it later for removing on mouseout
  //       x: function() { return xScale(d.x) - 30; },
  //       y: function() { return yScale(d.y) - 15; }
  //   })
  //   .text(function() {
  //     return [d.x, d.y];  // Value of the text
  //   });
  //     }

  // function handleMouseOut(d, i) {
  //   // Use D3 to select element, change color back to normal
  //   d3.select(this).attr({
  //     fill: "black",
  //     r: radius
  //   });

  //   // Select text by id and then remove
  //   d3.select("#t" + d.x + "-" + d.y + "-" + i).remove();  // Remove text location
  // }
})

</script>

</body>
</html>